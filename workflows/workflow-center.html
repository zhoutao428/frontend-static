<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å·¥ä½œæµæŒ‡æŒ¥ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="./workflow-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ–°å¢æ ·å¼è¡¥ä¸ - ç¡®ä¿å¡ç‰‡è¾¹æ¡† */
        .batch-controls { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 6px; }
        .mode-switch { font-size: 10px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .mode-switch.active { color: #6366f1; font-weight: bold; }
        .mode-switch i { font-size: 12px; }
        
        .add-card {
            border: 1px dashed #6366f1 !important;
            background: rgba(99,102,241,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 140px;
            transition: 0.2s;
        }
        .add-card:hover { 
            background: rgba(99,102,241,0.1); 
            transform: translateY(-2px); 
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2) !important;
        }
        
        /* ç¡®ä¿å³ä¾§å¡ç‰‡è¾¹æ¡† */
        #template-library .tpl-card {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <div class="brand">
            <i class="fas fa-satellite-dish pulse"></i>
            <span style="letter-spacing: 1px;">æˆ˜æœ¯æŒ‡æŒ¥ä¸­å¿ƒ</span>
        </div>
        <div class="top-controls">
            <div class="resource-monitor" style="display:flex; gap:15px; font-size:11px; color:#94a3b8; margin-right:20px;">
                <span><i class="fas fa-microchip"></i> CPU: <span style="color:#10b981">12%</span></span>
                <span><i class="fas fa-coins"></i> Token: <span style="color:#f59e0b" id="total-token-cost">0</span></span>
            </div>
            <div class="divider-v"></div>
            <button class="btn btn-ghost" onclick="window.location.href='../index.html'">
                <i class="fas fa-sign-out-alt"></i> é€€å‡º
            </button>
        </div>
    </header>

    <div class="workflow-layout">
        <!-- å·¦ä¾§ï¼šä»»åŠ¡æ‰§è¡Œå° -->
        <aside class="wf-sidebar">
            <div class="deck-header">
                <h3><i class="fas fa-layer-group"></i> ä»»åŠ¡é˜Ÿåˆ—</h3>
                
                <!-- æ‰¹é‡æ§åˆ¶æ  -->
                <div class="batch-controls">
                    <div class="mode-switch active" id="mode-parallel" onclick="setMode('parallel')" title="å¹¶è¡Œæ¨¡å¼">
                        <i class="fas fa-bolt"></i> å¹¶è¡Œ
                    </div>
                    <div class="mode-switch" id="mode-queue" onclick="setMode('queue')" title="æ’é˜Ÿæ¨¡å¼">
                        <i class="fas fa-hourglass-half"></i> æ’é˜Ÿ
                    </div>
                    <div style="width:1px; height:12px; background:#444; margin:0 4px;"></div>
                    <i class="fas fa-play-circle" onclick="startAllTasks()" style="cursor:pointer; color:#10b981;" title="å…¨éƒ¨å¼€å§‹"></i>
                    <i class="fas fa-pause-circle" onclick="pauseAllTasks()" style="cursor:pointer; color:#f59e0b;" title="å…¨éƒ¨æš‚åœ"></i>
                </div>
            </div>
            
            <div id="execution-pool" class="execution-pool">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </aside>

        <!-- å³ä¾§ï¼šæ¨¡ç»„åº“ -->
        <main class="wf-main">
            <div class="library-header">
                <h3><i class="fas fa-boxes"></i> æ¨¡ç»„åº“</h3>
                <div class="search-box">
                    <i class="fas fa-search" style="color:#64748b; margin-right:8px;"></i>
                    <input type="text" id="tpl-search" placeholder="æœç´¢æ¨¡ç»„..." style="background:transparent; border:none; color:white; outline:none;">
                </div>
            </div>
            <div id="template-library" class="template-grid"></div>
        </main>
    </div>

    <!-- è¯¦æƒ…æŠ½å±‰ -->
    <div id="detail-drawer" class="drawer-backdrop">
        <div class="drawer-panel right-side">
            <div class="drawer-header" style="padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h2 id="drawer-title" style="margin:0; font-size:16px;"><i class="fas fa-terminal"></i> ä»»åŠ¡ç›‘æ§</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-ghost" onclick="exportCurrentLog()"><i class="fas fa-download"></i> å¯¼å‡ºæ—¥å¿—</button>
                    <button class="btn btn-ghost" onclick="closeDrawer()"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="drawer-steps" class="step-flow"></div>
            <div class="terminal-wrapper">
                <div class="terminal-bar">
                    <span>root@ai-core:~# tail -f execution.log</span>
                    <span id="token-cost">æ¶ˆè€—: 0 KB</span>
                </div>
                <div id="terminal-content" class="terminal-content"></div>
            </div>
        </div>
    </div>

    <div id="confirm-drawer" class="drawer-backdrop">
        <div class="drawer-panel bottom-sheet">
            <h3 style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ç¡®è®¤ç»ˆæ­¢ä»»åŠ¡ï¼Ÿ</h3>
            <p style="color:#94a3b8; margin:10px 0 20px;">æœªä¿å­˜çš„è¿›åº¦å°†ä¼šä¸¢å¤±ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            <div class="drawer-footer">
                <button class="btn btn-ghost" onclick="closeConfirmDrawer()">å–æ¶ˆ</button>
                <button class="btn btn-danger-glow" id="btn-confirm-kill">ç¡®è®¤ç»ˆæ­¢</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æ¨¡æ¿æ•°æ® -->
    <script src="/frontend/workflows/api-bridge.js"></script>
    <script src="./workflow-templates.js"></script>
   
    <!-- ä¸»é€»è¾‘ -->
    <script>
        // å…œåº•æ¨¡æ¿æ•°æ®
        const FALLBACK_TEMPLATES = {
            'content': { 
                name: 'å†…å®¹åˆ›ä½œå·¥å‚', 
                icon: 'fas fa-film', 
                color: '#8b5cf6', 
                category: 'MEDIA', 
                steps: ['è¶‹åŠ¿åˆ†æ', 'é€‰é¢˜ç”Ÿæˆ', 'è„šæœ¬æ’°å†™', 'SEOä¼˜åŒ–'], 
                description: 'å…¨è‡ªåŠ¨è§†é¢‘è„šæœ¬ç”Ÿæˆæµæ°´çº¿',
                roles: ['analyst', 'planner', 'writer', 'seo'] 
            },
            'dev': { 
                name: 'å…¨æ ˆå¼€å‘', 
                icon: 'fas fa-code', 
                color: '#10b981', 
                category: 'DEV', 
                steps: ['éœ€æ±‚åˆ†æ', 'APIè®¾è®¡', 'å‰ç«¯å¼€å‘', 'åç«¯å®ç°'], 
                description: 'å‰åç«¯åˆ†ç¦»å¼€å‘æ ‡å‡†æµç¨‹',
                roles: ['pm', 'architect', 'frontend', 'backend'] 
            }
        };

        let instances = []; 
        let activeDrawerId = null;
        let pendingDeleteId = null;
        let executionMode = 'parallel';
        let queueRunning = false;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ å·¥ä½œæµä¸­å¿ƒå¯åŠ¨...');
            renderLibrary();
            initDropZone();
            renderTasks(); // åˆå§‹æ¸²æŸ“ç©ºçŠ¶æ€
        });

        // æ¸²æŸ“æ¨¡ç»„åº“
        function renderLibrary() {
            const container = document.getElementById('template-library');
            if(!container) return;
            
            // è·å–æ¨¡æ¿æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ window.WORKFLOW_TEMPLATESï¼‰
            let templates = window.WORKFLOW_TEMPLATES;
            if (!templates || Object.keys(templates).length === 0) {
                templates = FALLBACK_TEMPLATES;
                window.WORKFLOW_TEMPLATES = templates; // è®¾ç½®ä¸ºå…¨å±€
            }
            
            container.innerHTML = ''; // æ¸…ç©º
            
            // 1. æ–°å»ºå…¥å£
            const addCard = document.createElement('div');
            addCard.className = 'tpl-card add-card';
            addCard.innerHTML = `
                <i class="fas fa-plus-circle" style="font-size:32px; color:#6366f1;"></i>
                <span style="margin-top:10px; color:#818cf8; font-weight:bold;">æ–°å»ºæ¨¡ç»„</span>
            `;
            addCard.onclick = () => window.location.href = '../role-manager.html';
            container.appendChild(addCard);
            
            // 2. æ¸²æŸ“æ¨¡æ¿å¡ç‰‡
            Object.entries(templates).forEach(([id, tpl]) => {
                const card = document.createElement('div');
                card.className = 'tpl-card';
                card.draggable = true;
                card.dataset.id = id;
                
                const stepCount = tpl.steps ? tpl.steps.length : 0;
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="font-size:20px; color:${tpl.color || '#fff'}"><i class="${tpl.icon || 'fas fa-box'}"></i></div>
                        <div style="font-size:10px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${tpl.category || 'é€šç”¨'}</div>
                    </div>
                    <div style="font-weight:bold; margin-top:5px; font-size:14px; color:#fff;">${tpl.name}</div>
                    <div style="font-size:11px; color:#94a3b8; line-height:1.4; flex:1; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${tpl.description || 'æš‚æ— æè¿°'}</div>
                    <div style="margin-top:auto; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05); font-size:10px; color:#64748b;">
                        <i class="fas fa-layer-group"></i> ${stepCount} æ­¥éª¤
                        <span style="margin-left:8px;"><i class="fas fa-clock"></i> ${tpl.time || 'N/A'}</span>
                    </div>
                `;
                
                card.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', id);
                    card.style.opacity = '0.5';
                };
                card.ondragend = () => card.style.opacity = '1';
                
                container.appendChild(card);
            });
        }

        function initDropZone() {
            const zone = document.querySelector('.wf-sidebar');
            
            zone.ondragover = (e) => {
                e.preventDefault();
                zone.style.borderColor = '#6366f1';
                zone.style.boxShadow = '0 0 20px rgba(99,102,241,0.2) inset';
            };
            
            zone.ondragleave = () => {
                zone.style.borderColor = '';
                zone.style.boxShadow = '';
            };
            
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.style.borderColor = '';
                zone.style.boxShadow = '';
                
                const tplId = e.dataTransfer.getData('text/plain');
                
                // è·å–æ¨¡æ¿æ•°æ®
                let templates = window.WORKFLOW_TEMPLATES;
                if (!templates || Object.keys(templates).length === 0) {
                    templates = FALLBACK_TEMPLATES;
                }
                
                if (tplId && templates[tplId]) {
                    showWorkflowInputModal(templates[tplId].name, (userInput) => {
                        createTask(tplId, templates[tplId], userInput);
                    });
                }
            };
        }

        function createTask(tplId, tpl, userInput) {
            const task = {
                id: 'task_' + Date.now(),
                tpl: tpl,
                status: 'ready',
                progress: 0,
                currentStep: 0,
                logs: [`[System] ä»»åŠ¡å·²åˆ›å»º: ${tpl.name}`, `[Input] éœ€æ±‚: ${userInput}`],
                tokenCost: 0,
                timer: null,
                initialInput: userInput,
                results: [] // ç”¨äºå­˜å‚¨æ¯ä¸€æ­¥çš„ç»“æœ
            };
            instances.push(task);
            renderTasks();
            
            // å¦‚æœæ˜¯æ’é˜Ÿæ¨¡å¼ä¸”é˜Ÿåˆ—ç©ºé—²ï¼Œè‡ªåŠ¨å¯åŠ¨
            if (executionMode === 'queue' && !queueRunning) processQueue();
        }

        // ä¿®å¤ï¼šé¿å… getElementById('empty-pool-hint') ä¸º null
        function renderTasks() {
            const container = document.getElementById('execution-pool');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            if (instances.length === 0) {
                // åŠ¨æ€åˆ›å»ºç©ºçŠ¶æ€æç¤º
                container.innerHTML = `
                    <div id="empty-pool-hint" class="empty-hint">
                        <i class="fas fa-arrow-right" style="font-size:24px; margin-bottom:10px; color:#6366f1;"></i>
                        <p style="margin:0; color:#64748b;">DRAG MODULE HERE</p>
                        <span style="font-size:10px; opacity:0.6;">ä»å³ä¾§æ‹–å…¥æ¨¡å—å¯åŠ¨</span>
                    </div>
                `;
                document.getElementById('total-token-cost').innerText = 0;
                return;
            }
            
            // æ¸²æŸ“æ‰€æœ‰ä»»åŠ¡å¡ç‰‡
            instances.forEach(task => {
                const card = document.createElement('div');
                card.className = `task-card ${task.status}`;
                
                let statusIcon = 'fa-stop-circle';
                let statusText = 'å‡†å¤‡å°±ç»ª';
                if (task.status === 'running') { statusIcon = 'fa-spin fa-circle-notch'; statusText = 'è¿è¡Œä¸­'; }
                if (task.status === 'paused') { statusIcon = 'fa-pause-circle'; statusText = 'å·²æš‚åœ'; }
                if (task.status === 'completed') { statusIcon = 'fa-check-circle'; statusText = 'å·²å®Œæˆ'; }
                if (task.status === 'queue') { statusIcon = 'fa-hourglass-half'; statusText = 'æ’é˜Ÿä¸­'; }
                
                card.innerHTML = `
                    <div class="task-header">
                        <span>${task.tpl.name}</span>
                        <span style="font-size:10px; opacity:0.8;"><i class="fas ${statusIcon}"></i> ${statusText}</span>
                    </div>
                    <div class="task-progress-bar">
                        <div class="task-progress-fill" style="width:${task.progress}%"></div>
                    </div>
                    <div class="task-controls">
                        <button class="ctrl-btn play" onclick="startTask('${task.id}')" title="å¯åŠ¨"><i class="fas fa-play"></i></button>
                        <button class="ctrl-btn pause" onclick="pauseTask('${task.id}')" title="æš‚åœ"><i class="fas fa-pause"></i></button>
                        <button class="ctrl-btn stop" onclick="deleteTask('${task.id}')" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>
                        <div style="width:1px; background:rgba(255,255,255,0.1); margin:0 5px;"></div>
                        <button class="ctrl-btn" onclick="openDrawer('${task.id}')" title="è¯¦æƒ…"><i class="fas fa-eye"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // æ›´æ–°æ€»Token
            const total = instances.reduce((sum, t) => sum + t.tokenCost, 0);
            document.getElementById('total-token-cost').innerText = total;
        }

        // === æ‰§è¡Œé€»è¾‘ ===
        window.startTask = function(id) {
            const task = instances.find(t => t.id === id);
            if (!task || task.status === 'completed' || task.status === 'running') return;
            
            // æ’é˜Ÿæ¨¡å¼æ£€æŸ¥
            if (executionMode === 'queue') {
                const running = instances.find(t => t.status === 'running');
                if (running) {
                    task.status = 'queue';
                    task.logs.push(`[System] åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—ï¼Œç­‰å¾…ç©ºé—²...`);
                    renderTasks();
                    return;
                }
            }
            
            // å¯åŠ¨ä»»åŠ¡
            runTask(task);
        };

        // é™é»˜åˆ é™¤å‡½æ•°
        window.deleteTask = function(id) {
            const task = instances.find(t => t.id === id);
            
            if (task && task.timer) {
                clearInterval(task.timer);
            }
            
            instances = instances.filter(t => t.id !== id);
            
            if (activeDrawerId === id) {
                closeDrawer();
            }
            
            renderTasks();
            
            // å¦‚æœæ˜¯æ’é˜Ÿæ¨¡å¼ï¼Œåˆ é™¤åæ£€æŸ¥ä¸‹ä¸€ä¸ª
            if (executionMode === 'queue') {
                processQueue();
            }
        };

        // çœŸå®æ‰§è¡Œé€»è¾‘
        async function runTask(task) {
            if (task.status === 'running') return;
            
            task.status = 'running';
            task.logs.push(`[System] ğŸš€ ä»»åŠ¡å¯åŠ¨ï¼Œæ¥å…¥ç¥ç»ç½‘ç»œ...`);
            renderTasks();
            
            if(activeDrawerId === task.id) updateDrawerUI(task);

            // å®šä¹‰ä¸Šä¸‹æ–‡
            let context = {
                initial_input: task.initialInput,
                history: []
            };

            try {
                // éå†æ‰€æœ‰æ­¥éª¤
                for (let i = task.currentStep; i < task.tpl.steps.length; i++) {
                    
                    // æ£€æŸ¥æš‚åœçŠ¶æ€
                    if (task.status === 'paused') {
                        task.logs.push(`[System] â¸ï¸ ä»»åŠ¡å·²æš‚åœåœ¨æ­¥éª¤ ${i+1}`);
                        task.currentStep = i; // è®°å½•å½“å‰ä½ç½®
                        break;
                    }

                    const stepName = task.tpl.steps[i];
                    task.currentStep = i;
                    task.progress = Math.round((i / task.tpl.steps.length) * 100);
                    renderTasks();
                    
                    if(activeDrawerId === task.id) updateDrawerUI(task);

                    // æ„é€  Prompt
                    const currentRole = task.tpl.roles ? task.tpl.roles[i % task.tpl.roles.length] : 'idea';
                    
                    let prompt = `ã€é¡¹ç›®æ ¸å¿ƒç›®æ ‡ã€‘ï¼š${context.initial_input}\n\n`;
                    prompt += `ã€å½“å‰ä»»åŠ¡æ­¥éª¤ã€‘ï¼š${stepName}\n`;
                    prompt += `è¯·ä½œä¸ºè¯¥é¢†åŸŸçš„ä¸“å®¶ï¼Œå®Œæˆä¸Šè¿°æ­¥éª¤ã€‚\n\n`;
                    
                    if (context.history.length > 0) {
                        const lastOutput = context.history[context.history.length - 1];
                        prompt += `ã€ä¸Šä¸€æ­¥å·¥ä½œæˆæœ (å‚è€ƒ)ã€‘ï¼š\n${lastOutput.substring(0, 3000)}\n\n`;
                        prompt += `è¯·åŸºäºä¸Šä¸€æ­¥çš„æˆæœç»§ç»­æ·±åŒ–/æ‰§è¡Œã€‚`;
                    } else {
                        prompt += `è¿™æ˜¯å·¥ä½œæµçš„ç¬¬ä¸€æ­¥ï¼Œè¯·æ ¹æ®æ ¸å¿ƒç›®æ ‡å¼€å§‹è§„åˆ’ã€‚`;
                    }

                    // è°ƒç”¨ API
                    const startTime = Date.now();
                    try {
                        const response = await WorkflowAPI.callAgent(currentRole, prompt);
                        
                        const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                        
                        // å¤„ç†ç»“æœ
                        task.logs.push(`[Agent] âœ… å®Œæˆ (${duration}s): ${response.substring(0, 50)}...`);
                        context.history.push(response);
                        
                        if (!task.results) task.results = [];
                        task.results.push(response);
                        
                        // ä¼°ç®— Token
                        task.tokenCost += (prompt.length + response.length);

                    } catch (err) {
                        console.error(err);
                        task.status = 'error';
                        task.logs.push(`[Error] âŒ è°ƒç”¨å¤±è´¥: ${err.message}`);
                        renderTasks();
                        if(activeDrawerId === task.id) updateDrawerUI(task);
                        return;
                    }

                    // ç¨å¾®åœé¡¿
                    await new Promise(r => setTimeout(r, 500));
                }

                // å¾ªç¯ç»“æŸæ£€æŸ¥
                if (task.status === 'running') {
                    task.status = 'completed';
                    task.progress = 100;
                    task.logs.push(`[System] ğŸ‰ æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•ï¼`);
                    renderTasks();
                    
                    if(activeDrawerId === task.id) updateDrawerUI(task);
                    
                    // æ’é˜Ÿæ¨¡å¼ï¼šè‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªä»»åŠ¡
                    if (executionMode === 'queue') {
                        setTimeout(() => {
                            processQueue();
                        }, 1000);
                    }
                }

            } catch (e) {
                console.error("Engine Error:", e);
                task.status = 'error';
                task.logs.push(`[Error] æ‰§è¡Œé”™è¯¯: ${e.message}`);
                renderTasks();
            }
        }

        function processQueue() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä»»åŠ¡åœ¨è¿è¡Œ
            const running = instances.find(t => t.status === 'running');
            if (running && executionMode === 'queue') return;
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ’é˜Ÿä¸­çš„ä»»åŠ¡
            const next = instances.find(t => t.status === 'queue' || (t.status === 'ready' && executionMode === 'queue'));
            if (next) {
                queueRunning = true;
                runTask(next);
            } else {
                queueRunning = false;
            }
        }

        window.pauseTask = function(id) {
            const task = instances.find(t => t.id === id);
            if (!task || task.status !== 'running') return;
            
            if (task.timer) {
                clearInterval(task.timer);
                task.timer = null;
            }
            
            task.status = 'paused';
            task.logs.push(`[System] â¸ï¸ ä»»åŠ¡å·²æš‚åœ`);
            
            // å¦‚æœæ˜¯æ’é˜Ÿæ¨¡å¼ï¼Œæš‚åœåå¯åŠ¨ä¸‹ä¸€ä¸ª
            if (executionMode === 'queue') {
                processQueue();
            }
            
            renderTasks();
            if (activeDrawerId === id) updateDrawerUI(task);
        };

        // æ‰¹é‡æ§åˆ¶
        window.startAllTasks = function() {
            if (executionMode === 'queue') {
                // æ’é˜Ÿæ¨¡å¼åªå¯åŠ¨ç¬¬ä¸€ä¸ª
                const firstReady = instances.find(t => t.status === 'ready' || t.status === 'queue');
                if (firstReady) startTask(firstReady.id);
            } else {
                // å¹¶è¡Œæ¨¡å¼å¯åŠ¨æ‰€æœ‰å°±ç»ªçš„
                instances.forEach(t => {
                    if(t.status === 'ready' || t.status === 'paused') startTask(t.id);
                });
            }
        };
        
        window.pauseAllTasks = function() {
            instances.forEach(t => {
                if(t.status === 'running') pauseTask(t.id);
            });
        };
        
        window.setMode = function(mode) {
            executionMode = mode;
            document.getElementById('mode-parallel').classList.toggle('active', mode === 'parallel');
            document.getElementById('mode-queue').classList.toggle('active', mode === 'queue');
            
            if (mode === 'queue') {
                // åˆ‡æ¢åˆ°æ’é˜Ÿæ¨¡å¼
                const runningTasks = instances.filter(t => t.status === 'running');
                if (runningTasks.length > 1) {
                    // ä¿ç•™ç¬¬ä¸€ä¸ªè¿è¡Œï¼Œå…¶ä»–çš„æ”¹ä¸ºæ’é˜Ÿ
                    for(let i = 1; i < runningTasks.length; i++) {
                        const task = runningTasks[i];
                        task.status = 'queue';
                        task.logs.push(`[System] åˆ‡æ¢åˆ°æ’é˜Ÿæ¨¡å¼ï¼Œä»»åŠ¡è¿›å…¥é˜Ÿåˆ—ç­‰å¾…...`);
                    }
                }
                
                // å°†æ‰€æœ‰ ready çŠ¶æ€çš„ä»»åŠ¡æ”¹ä¸º queue
                instances.forEach(task => {
                    if (task.status === 'ready') {
                        task.status = 'queue';
                    }
                });
                
                renderTasks();
                if (!queueRunning) processQueue();
            } else {
                // å¹¶è¡Œæ¨¡å¼
                instances.forEach(task => {
                    if (task.status === 'queue') {
                        task.status = 'ready';
                    }
                });
                renderTasks();
            }
        };

        // === æŠ½å±‰é€»è¾‘ ===
        window.openDrawer = function(id) {
            const task = instances.find(t => t.id === id);
            if(!task) return;
            activeDrawerId = id;
            document.getElementById('detail-drawer').classList.add('open');
            updateDrawerUI(task);
        };

        window.closeDrawer = function() {
            document.getElementById('detail-drawer').classList.remove('open');
            activeDrawerId = null;
        };

        function updateDrawerUI(task) {
            document.getElementById('drawer-title').innerHTML = `<i class="fas fa-terminal"></i> ${task.tpl.name} - ${task.status.toUpperCase()}`;
            document.getElementById('token-cost').innerText = `æ¶ˆè€—: ${task.tokenCost} KB`;
            
            const term = document.getElementById('terminal-content');
            term.innerHTML = task.logs.map(l => `<div class="log-line">${l}</div>`).join('');
            term.scrollTop = term.scrollHeight;
            
            const stepsDiv = document.getElementById('drawer-steps');
            stepsDiv.innerHTML = '';
            
            if (task.tpl.steps) {
                task.tpl.steps.forEach((s, i) => {
                    const d = document.createElement('div');
                    d.style.padding = '5px 10px';
                    d.style.fontSize = '12px';
                    d.style.borderRadius = '4px';
                    d.style.marginRight = '10px';
                    d.style.whiteSpace = 'nowrap';
                    
                    if (i < task.currentStep) {
                        d.style.color = '#10b981';
                        d.style.background = 'rgba(16,185,129,0.1)';
                        d.innerHTML = `<i class="fas fa-check"></i> ${s}`;
                    } else if (i === task.currentStep && task.status === 'running') {
                        d.style.color = '#f59e0b';
                        d.style.border = '1px solid #f59e0b';
                        d.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${s}`;
                    } else {
                        d.style.color = '#64748b';
                        d.innerHTML = `${i+1}. ${s}`;
                    }
                    stepsDiv.appendChild(d);
                });
            }
        }

        window.exportCurrentLog = function() {
            if(!activeDrawerId) return;
            const task = instances.find(t => t.id === activeDrawerId);
            
            let content = `=== å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š: ${task.tpl.name} ===\n`;
            content += `æ—¶é—´: ${new Date().toLocaleString()}\n`;
            content += `æ ¸å¿ƒéœ€æ±‚: ${task.initialInput}\n\n`;
            content += `----------------------------------------\n\n`;
            
            if (task.results && task.results.length > 0) {
                task.results.forEach((res, index) => {
                    const stepName = task.tpl.steps[index] || `æ­¥éª¤ ${index + 1}`;
                    content += `### æ­¥éª¤ ${index + 1}: ${stepName}\n\n`;
                    content += `${res}\n\n`;
                    content += `----------------------------------------\n\n`;
                });
            } else {
                content += task.logs.join('\n');
            }
            
            const blob = new Blob([content], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${task.tpl.name}_Report.txt`;
            a.click();
        };

        window.requestStopTask = function(id) {
            pendingDeleteId = id;
            document.getElementById('confirm-drawer').classList.add('open');
        };

        window.closeConfirmDrawer = function() {
            document.getElementById('confirm-drawer').classList.remove('open');
            pendingDeleteId = null;
        };

        document.getElementById('btn-confirm-kill').onclick = () => {
            if(pendingDeleteId) {
                const task = instances.find(t => t.id === pendingDeleteId);
                if(task && task.timer) clearInterval(task.timer);
                instances = instances.filter(t => t.id !== pendingDeleteId);
                renderTasks();
                if(activeDrawerId === pendingDeleteId) closeDrawer();
                closeConfirmDrawer();
                
                // é˜Ÿåˆ—æ¨¡å¼æ£€æŸ¥ä¸‹ä¸€ä¸ª
                if (executionMode === 'queue') processQueue();
            }
        };

        // å¼¹çª—è¾…åŠ©
        function showWorkflowInputModal(tplName, callback) {
            const modalHtml = `
                <div id="wf-input-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); z-index:9999; display:flex; align-items:center; justify-content:center; animation: fadeIn 0.2s;">
                    <div style="background:#1e293b; padding:30px; border-radius:16px; border:1px solid #6366f1; width:400px; box-shadow:0 20px 50px rgba(0,0,0,0.6); transform: translateY(0); animation: slideUp 0.3s;">
                        <h3 style="margin-top:0; color:#fff; font-size:18px;"><i class="fas fa-rocket" style="color:#6366f1"></i> å¯åŠ¨: ${tplName}</h3>
                        <p style="color:#94a3b8; font-size:13px; margin:10px 0;">è¯·è¾“å…¥è¯¥ä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡æˆ–ä¸»é¢˜ï¼š</p>
                        <textarea id="wf-input-val" style="width:100%; padding:12px; margin:15px 0; background:rgba(0,0,0,0.3); border:1px solid #444; color:white; border-radius:8px; font-size:14px; outline:none; min-height:80px; resize:vertical;" placeholder="ä¾‹å¦‚ï¼šå†™ä¸€ç¯‡å…³äºAIçš„å…¬ä¼—å·æ–‡ç« ..."></textarea>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                            <div style="font-size:11px; color:#64748b;">
                                <i class="fas fa-info-circle"></i> æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæè¿°è¶Šè¯¦ç»†è¶Šå¥½
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button id="wf-btn-cancel" class="btn btn-ghost" style="border:1px solid #444;">å–æ¶ˆ</button>
                                <button id="wf-btn-confirm" class="btn btn-primary-glow" style="background:#6366f1; color:white; border:none;">ğŸš€ ç«‹å³å¯åŠ¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = modalHtml;
            document.body.appendChild(div);
            
            const input = div.querySelector('#wf-input-val');
            input.focus();
            
            const close = () => {
                div.style.animation = 'fadeOut 0.2s';
                setTimeout(() => div.remove(), 200);
            };
            
            div.querySelector('#wf-btn-cancel').onclick = close;
            div.querySelector('#wf-btn-confirm').onclick = () => {
                const val = input.value.trim();
                if(val) {
                    callback(val);
                    close();
                } else {
                    input.style.border = '1px solid #ef4444';
                    input.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        input.style.animation = '';
                        input.style.border = '1px solid #ef4444';
                    }, 500);
                }
            };
            
            input.onkeydown = (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    div.querySelector('#wf-btn-confirm').click();
                }
            };
            
            document.addEventListener('keydown', function escHandler(e) {
                if(e.key === 'Escape') {
                    close();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
    </script>
    <script src="/js/role-loader.js"></script>
</body>

</html>
